# API Promotion Workflow
# Handles promotion of APIs between environments with approvals
name: API Promotion

on:
  workflow_dispatch:
    inputs:
      api_name:
        description: 'API name to promote'
        required: true
        type: string
      source_env:
        description: 'Source environment'
        required: true
        type: choice
        options:
          - dev
          - uat
      target_env:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - uat
          - prod
      version:
        description: 'API version (semver)'
        required: true
        type: string
      change_description:
        description: 'Description of changes'
        required: true
        type: string

env:
  GIT_AUTHOR_NAME: 'GitHub Actions'
  GIT_AUTHOR_EMAIL: 'actions@github.com'

jobs:
  # ============================================================================
  # Validate Promotion Request
  # ============================================================================
  validate:
    name: Validate Promotion
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
      api_path: ${{ steps.validate.outputs.api_path }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate promotion path
        id: validate
        run: |
          # Validate source -> target path
          if [[ "${{ inputs.source_env }}" == "dev" && "${{ inputs.target_env }}" != "uat" ]]; then
            echo "::error::Dev can only be promoted to UAT"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [[ "${{ inputs.source_env }}" == "uat" && "${{ inputs.target_env }}" != "prod" ]]; then
            echo "::error::UAT can only be promoted to Prod"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check if API exists
          API_PATH="apis/base/${{ inputs.api_name }}"
          if [[ ! -d "$API_PATH" ]]; then
            echo "::error::API not found: ${{ inputs.api_name }}"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "api_path=$API_PATH" >> $GITHUB_OUTPUT
      
      - name: Validate version format
        run: |
          if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Version must be in semver format (e.g., 1.2.3)"
            exit 1
          fi
      
      - name: Check current version
        run: |
          CURRENT_VERSION=$(yq '.spec.version' apis/base/${{ inputs.api_name }}/api-definition.yaml)
          echo "Current version: $CURRENT_VERSION"
          echo "Target version: ${{ inputs.version }}"
          
          # Simple version comparison (could be enhanced)
          if [[ "$CURRENT_VERSION" == "${{ inputs.version }}" ]]; then
            echo "::warning::Version unchanged - consider incrementing"
          fi

  # ============================================================================
  # Run Tests Before Promotion
  # ============================================================================
  pre-promotion-tests:
    name: Pre-Promotion Tests
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.valid == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install kustomize
        run: |
          curl -L https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.3.0/kustomize_v5.3.0_linux_amd64.tar.gz | tar xz
          sudo mv kustomize /usr/local/bin/
      
      - name: Build and validate target environment
        run: |
          kustomize build apis/overlays/${{ inputs.target_env }} > /tmp/manifests.yaml
          python3 scripts/validate-gko-crds.py /tmp/manifests.yaml
      
      - name: Run policy validation
        run: |
          python3 scripts/validate-policies.py apis/base/${{ inputs.api_name }}
      
      - name: Check for breaking changes
        run: |
          echo "Checking for breaking changes..."
          # Add breaking change detection logic here
          # e.g., removed endpoints, changed request/response schemas

  # ============================================================================
  # Approval Gate for Production
  # ============================================================================
  approval:
    name: Approval Gate
    runs-on: ubuntu-latest
    needs: [validate, pre-promotion-tests]
    if: inputs.target_env == 'prod'
    environment: production-approval
    
    steps:
      - name: Request approval
        run: |
          echo "üîê Production promotion requires approval"
          echo ""
          echo "API: ${{ inputs.api_name }}"
          echo "Version: ${{ inputs.version }}"
          echo "From: ${{ inputs.source_env }}"
          echo "To: ${{ inputs.target_env }}"
          echo ""
          echo "Changes: ${{ inputs.change_description }}"

  # ============================================================================
  # Perform Promotion
  # ============================================================================
  promote:
    name: Promote API
    runs-on: ubuntu-latest
    needs: [validate, pre-promotion-tests, approval]
    if: |
      always() && 
      needs.validate.outputs.valid == 'true' && 
      needs.pre-promotion-tests.result == 'success' &&
      (needs.approval.result == 'success' || inputs.target_env != 'prod')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "${{ env.GIT_AUTHOR_NAME }}"
          git config user.email "${{ env.GIT_AUTHOR_EMAIL }}"
      
      - name: Update API version
        run: |
          API_DEF="apis/base/${{ inputs.api_name }}/api-definition.yaml"
          
          # Update version in API definition
          yq -i '.spec.version = "${{ inputs.version }}"' "$API_DEF"
          
          # Add promotion metadata
          yq -i '.metadata.annotations["api.gravitee.io/promoted-from"] = "${{ inputs.source_env }}"' "$API_DEF"
          yq -i '.metadata.annotations["api.gravitee.io/promoted-at"] = "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"' "$API_DEF"
          yq -i '.metadata.annotations["api.gravitee.io/promoted-by"] = "${{ github.actor }}"' "$API_DEF"
      
      - name: Create promotion branch
        run: |
          BRANCH_NAME="promote/${{ inputs.api_name }}-v${{ inputs.version }}-to-${{ inputs.target_env }}"
          git checkout -b "$BRANCH_NAME"
      
      - name: Commit changes
        run: |
          git add apis/
          git commit -m "chore: promote ${{ inputs.api_name }} v${{ inputs.version }} to ${{ inputs.target_env }}
          
          Promoted from: ${{ inputs.source_env }}
          Promoted by: ${{ github.actor }}
          
          Changes:
          ${{ inputs.change_description }}"
      
      - name: Push changes
        run: |
          BRANCH_NAME="promote/${{ inputs.api_name }}-v${{ inputs.version }}-to-${{ inputs.target_env }}"
          git push origin "$BRANCH_NAME"
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "promote/${{ inputs.api_name }}-v${{ inputs.version }}-to-${{ inputs.target_env }}"
          base: main
          title: "üöÄ Promote ${{ inputs.api_name }} v${{ inputs.version }} to ${{ inputs.target_env }}"
          body: |
            ## API Promotion Request
            
            | Field | Value |
            |-------|-------|
            | **API** | ${{ inputs.api_name }} |
            | **Version** | ${{ inputs.version }} |
            | **Source** | ${{ inputs.source_env }} |
            | **Target** | ${{ inputs.target_env }} |
            | **Requested By** | @${{ github.actor }} |
            
            ### Changes
            ${{ inputs.change_description }}
            
            ### Pre-Promotion Checks
            - ‚úÖ CRD Validation passed
            - ‚úÖ Policy Validation passed
            - ‚úÖ Security Scan passed
            
            ### Post-Merge Actions
            - ArgoCD will automatically sync to ${{ inputs.target_env }}
            - Monitor deployment in ArgoCD dashboard
            
            ---
            _This PR was automatically created by the API Promotion workflow._
          labels: |
            promotion
            ${{ inputs.target_env }}
            automated
          reviewers: |
            api-reviewers
          draft: false

  # ============================================================================
  # Notify Stakeholders
  # ============================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [promote]
    if: always()
    
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "üöÄ API Promotion Request",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ API Promotion Request"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*API:*\n${{ inputs.api_name }}"},
                    {"type": "mrkdwn", "text": "*Version:*\n${{ inputs.version }}"},
                    {"type": "mrkdwn", "text": "*From:*\n${{ inputs.source_env }}"},
                    {"type": "mrkdwn", "text": "*To:*\n${{ inputs.target_env }}"},
                    {"type": "mrkdwn", "text": "*Requested By:*\n${{ github.actor }}"},
                    {"type": "mrkdwn", "text": "*Status:*\n${{ needs.promote.result }}"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Changes:*\n${{ inputs.change_description }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

