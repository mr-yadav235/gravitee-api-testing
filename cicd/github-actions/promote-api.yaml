# GitHub Actions Workflow: Promote APIs between environments
# Creates PR to promote APIs from one environment to another
name: Promote API

on:
  workflow_dispatch:
    inputs:
      source_env:
        description: 'Source environment'
        required: true
        type: choice
        options:
          - dev
          - uat
      target_env:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - uat
          - prod
      api_name:
        description: 'API name (leave empty for all)'
        required: false
        type: string

jobs:
  validate-promotion:
    name: Validate Promotion Path
    runs-on: ubuntu-latest
    steps:
      - name: Validate promotion path
        run: |
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.target_env }}"
          
          # Validate promotion path
          if [ "$SOURCE" == "dev" ] && [ "$TARGET" == "prod" ]; then
            echo "âŒ Cannot promote directly from dev to prod. Please promote to uat first."
            exit 1
          fi
          
          if [ "$SOURCE" == "$TARGET" ]; then
            echo "âŒ Source and target environments cannot be the same."
            exit 1
          fi
          
          if [ "$SOURCE" == "uat" ] && [ "$TARGET" == "dev" ]; then
            echo "âŒ Cannot demote from uat to dev."
            exit 1
          fi
          
          echo "âœ“ Valid promotion path: $SOURCE â†’ $TARGET"

  create-promotion-pr:
    name: Create Promotion PR
    runs-on: ubuntu-latest
    needs: validate-promotion
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Create promotion branch
        id: create-branch
        run: |
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.target_env }}"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BRANCH="promote/${SOURCE}-to-${TARGET}-${TIMESTAMP}"
          
          git checkout -b $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Copy API definitions
        run: |
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.target_env }}"
          API_NAME="${{ github.event.inputs.api_name }}"
          
          echo "Promoting APIs from $SOURCE to $TARGET..."
          
          # If specific API is specified
          if [ -n "$API_NAME" ]; then
            echo "Promoting specific API: $API_NAME"
            # Copy specific API files
            cp cicd/environments/$SOURCE/*$API_NAME*.yaml cicd/environments/$TARGET/ 2>/dev/null || true
          else
            echo "Promoting all APIs"
            # This is handled by Kustomize overlays - just update version/timestamp
          fi
          
          # Update promotion metadata
          cat > cicd/environments/$TARGET/promotion-info.yaml << EOF
          # Promotion Information
          # This file is auto-generated during promotion
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: promotion-info
            namespace: gravitee-apis-$TARGET
          data:
            promoted_from: "$SOURCE"
            promoted_at: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            promoted_by: "${{ github.actor }}"
            source_commit: "${{ github.sha }}"
          EOF

      - name: Commit changes
        run: |
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.target_env }}"
          
          git add .
          git commit -m "chore: promote APIs from $SOURCE to $TARGET

          Promoted by: ${{ github.actor }}
          Source commit: ${{ github.sha }}
          
          [skip ci]"

      - name: Push branch
        run: |
          git push origin ${{ steps.create-branch.outputs.branch }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.create-branch.outputs.branch }}
          base: main
          title: "ðŸš€ Promote APIs: ${{ github.event.inputs.source_env }} â†’ ${{ github.event.inputs.target_env }}"
          body: |
            ## API Promotion Request
            
            **Source Environment:** ${{ github.event.inputs.source_env }}
            **Target Environment:** ${{ github.event.inputs.target_env }}
            **Requested by:** @${{ github.actor }}
            
            ### Changes
            This PR promotes API definitions from `${{ github.event.inputs.source_env }}` to `${{ github.event.inputs.target_env }}`.
            
            ### Checklist
            - [ ] API tests passed in source environment
            - [ ] No breaking changes
            - [ ] Documentation updated (if needed)
            - [ ] Stakeholders notified
            
            ### Approval Required
            ${{ github.event.inputs.target_env == 'prod' && 'âš ï¸ **Production deployment requires approval from API Admin team.**' || '' }}
          labels: |
            promotion
            ${{ github.event.inputs.target_env }}
            automated
          reviewers: |
            ${{ github.event.inputs.target_env == 'prod' && 'api-admins' || '' }}
          draft: ${{ github.event.inputs.target_env == 'prod' }}

      - name: Notify
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "ðŸš€ API Promotion PR Created",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*API Promotion Request*\n*From:* ${{ github.event.inputs.source_env }}\n*To:* ${{ github.event.inputs.target_env }}\n*By:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

